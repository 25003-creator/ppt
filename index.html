<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바이브 코딩 숙제 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .importance-high { color: #ef4444; font-weight: 700; }
        .importance-medium { color: #f59e0b; font-weight: 600; }
        .importance-low { color: #10b981; font-weight: 500; }
        .time-remaining { font-size: 1.25rem; }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div class="max-w-3xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">⏰ 숙제 마감 카운트다운</h1>
        
        <!-- 숙제 추가 입력 폼 -->
        <div id="add-form" class="card p-6 mb-8 border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">새 숙제 추가</h2>
            
            <!-- ✅ 오류 메시지를 표시할 영역 추가 -->
            <div id="formMessage" class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 border border-red-400 rounded-lg" role="alert"></div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                
                <!-- 숙제 이름 -->
                <div class="md:col-span-2">
                    <label for="homeworkName" class="block text-sm font-medium text-gray-700 mb-1">숙제 이름</label>
                    <input type="text" id="homeworkName" placeholder="예: 수학 과제 #3" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- 마감 기한 (날짜 및 시간) -->
                <div>
                    <label for="deadlineDateTime" class="block text-sm font-medium text-gray-700 mb-1">마감 기한</label>
                    <input type="datetime-local" id="deadlineDateTime" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 중요도 -->
                <div>
                    <label for="importance" class="block text-sm font-medium text-gray-700 mb-1">중요도 (1-5)</label>
                    <select id="importance" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white">
                        <option value="5">5 - 매우 중요 (Very High)</option>
                        <option value="4">4 - 중요 (High)</option>
                        <option value="3" selected>3 - 보통 (Medium)</option>
                        <option value="2">2 - 낮음 (Low)</option>
                        <option value="1">1 - 매우 낮음 (Very Low)</option>
                    </select>
                </div>
            </div>
            
            <button id="addHomeworkBtn"
                    class="mt-6 w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                숙제 추가
            </button>
        </div>

        <!-- 숙제 목록 및 정렬 결과 -->
        <div class="card p-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                숙제 목록 (중요도 및 기한순 정렬)
                <span id="loadingStatus" class="text-sm text-indigo-500">데이터 로딩 중...</span>
            </h2>
            <div id="homeworksList" class="space-y-4">
                <!-- 숙제 항목이 여기에 동적으로 추가됩니다 -->
                <p id="noHomeworks" class="text-gray-500 text-center py-4 hidden">아직 등록된 숙제가 없습니다.</p>
            </div>
        </div>

        <!-- 사용자 ID 표시 (멀티 유저 환경에서 필수) -->
        <div class="mt-6 p-4 text-sm text-center text-gray-600 bg-gray-100 rounded-lg">
            <span class="font-semibold">현재 사용자 ID:</span> <span id="currentUserId">...</span>
        </div>

    </div>

    <!-- Firebase SDK 및 앱 로직 -->
    <script type="module">
        // ✅ setLogLevel의 import 위치를 firebase-app.js로 이동했습니다.
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, deleteDoc, addDoc, onSnapshot, collection, query, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정 (Canvas 환경에서 제공되는 전역 변수 사용)
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = 'anonymous';
        let homeworksData = []; // 숙제 데이터를 저장할 배열
        let updateInterval; // 실시간 업데이트를 위한 타이머

        // UI 요소
        const homeworkNameInput = document.getElementById('homeworkName');
        const deadlineDateTimeInput = document.getElementById('deadlineDateTime');
        const importanceInput = document.getElementById('importance');
        const addHomeworkBtn = document.getElementById('addHomeworkBtn');
        const homeworksList = document.getElementById('homeworksList');
        const loadingStatus = document.getElementById('loadingStatus');
        const noHomeworks = document.getElementById('noHomeworks');
        const currentUserIdSpan = document.getElementById('currentUserId');
        // ✅ 오류 메시지 표시 영역
        const formMessage = document.getElementById('formMessage'); 

        // 1. Firebase 초기화 및 인증 설정
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 인증 처리
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 인증 상태 변경 감지 및 userId 설정
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdSpan.textContent = userId;
                        // 인증 완료 후 데이터 리스너 시작
                        startHomeworkListener();
                    } else {
                        // 익명 사용자 또는 로그아웃 상태 처리
                        userId = crypto.randomUUID(); // 임시 ID
                        currentUserIdSpan.textContent = `비인증 (임시 ID: ${userId.substring(0, 8)}...)`;
                        loadingStatus.textContent = '인증 대기 중...';
                    }
                });

            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                loadingStatus.textContent = '❌ 오류 발생: Firebase 초기화 실패';
            }
        };

        // 2. 남은 시간 계산 함수
        const getTimeRemainingString = (deadlineTimestamp) => {
            const now = new Date().getTime();
            const deadlineTime = deadlineTimestamp.toDate().getTime();
            let distance = deadlineTime - now;

            if (distance < 0) {
                return '<span class="text-red-600 font-bold">마감 기한 지남!</span>';
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            let timeString = '';
            if (days > 0) timeString += `${days}일 `;
            if (hours > 0 || days > 0) timeString += `${hours}시간 `;
            if (minutes > 0 || hours > 0 || days > 0) timeString += `${minutes}분 `;
            timeString += `${seconds}초 남음`;
            
            return timeString.trim();
        };

        // 3. 중요도 클래스 및 텍스트 매핑
        const getImportanceDetails = (importanceLevel) => {
            const level = parseInt(importanceLevel);
            switch (level) {
                case 5: return { text: '매우 중요 (5)', class: 'importance-high text-red-600' };
                case 4: return { text: '중요 (4)', class: 'importance-high text-orange-500' };
                case 3: return { text: '보통 (3)', class: 'importance-medium text-yellow-600' };
                case 2: return { text: '낮음 (2)', class: 'importance-low text-green-500' };
                case 1: return { text: '매우 낮음 (1)', class: 'importance-low text-gray-500' };
                default: return { text: '알 수 없음', class: 'text-gray-400' };
            }
        };

        // 4. 숙제 리스트 렌더링 및 정렬 함수
        const renderHomeworks = () => {
            homeworksList.innerHTML = '';
            
            // 1차 정렬: 중요도 (높은 것부터), 2차 정렬: 마감 기한 (가까운 것부터)
            const sortedHomeworks = [...homeworksData].sort((a, b) => {
                // 중요도 역순 정렬 (5, 4, 3, 2, 1)
                const importanceDiff = b.importance - a.importance;
                if (importanceDiff !== 0) return importanceDiff;

                // 중요도가 같으면 마감 기한 순 정렬 (빠른 것이 먼저)
                const deadlineA = a.deadline.toDate().getTime();
                const deadlineB = b.deadline.toDate().getTime();
                return deadlineA - deadlineB;
            });

            if (sortedHomeworks.length === 0) {
                noHomeworks.classList.remove('hidden');
            } else {
                noHomeworks.classList.add('hidden');
            }

            sortedHomeworks.forEach(hw => {
                const item = document.createElement('div');
                item.className = 'flex flex-col sm:flex-row items-start sm:items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition duration-100 border border-gray-200';
                item.setAttribute('data-id', hw.id);

                const importanceDetail = getImportanceDetails(hw.importance);
                
                // 마감 기한 포맷팅 (YYYY-MM-DD HH:mm)
                const deadlineDate = hw.deadline.toDate();
                const formattedDeadline = `${deadlineDate.getFullYear()}-${String(deadlineDate.getMonth() + 1).padStart(2, '0')}-${String(deadlineDate.getDate()).padStart(2, '0')} ${String(deadlineDate.getHours()).padStart(2, '0')}:${String(deadlineDate.getMinutes()).padStart(2, '0')}`;


                item.innerHTML = `
                    <div class="flex-grow min-w-0 mb-2 sm:mb-0">
                        <div class="text-lg font-bold text-gray-800">${hw.name}</div>
                        <div class="text-sm text-gray-500 mt-0.5">마감: ${formattedDeadline}</div>
                        <div class="text-sm font-medium ${importanceDetail.class}">중요도: ${importanceDetail.text}</div>
                    </div>
                    <div class="flex-shrink-0 text-right sm:ml-4">
                        <div class="time-remaining font-mono text-gray-700 whitespace-nowrap" data-deadline="${hw.deadline.toMillis()}">
                            ${getTimeRemainingString(hw.deadline)}
                        </div>
                        <button class="ml-2 mt-2 sm:mt-0 text-red-500 hover:text-red-700 transition duration-150 text-sm delete-btn" data-id="${hw.id}">
                            삭제
                        </button>
                    </div>
                `;
                homeworksList.appendChild(item);
            });
        };

        // 5. 실시간 카운트다운 업데이트
        const startCountdown = () => {
            if (updateInterval) clearInterval(updateInterval); // 기존 타이머 제거

            updateInterval = setInterval(() => {
                // DOM을 순회하며 모든 카운트다운 시간 업데이트
                document.querySelectorAll('.time-remaining').forEach(el => {
                    const deadlineMs = parseInt(el.getAttribute('data-deadline'));
                    if (isNaN(deadlineMs)) return;

                    const now = new Date().getTime();
                    const distance = deadlineMs - now;

                    if (distance < 0) {
                        el.innerHTML = '<span class="text-red-600 font-bold">마감 기한 지남!</span>';
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    let timeString = '';
                    if (days > 0) timeString += `${days}일 `;
                    if (hours > 0 || days > 0) timeString += `${hours}시간 `;
                    if (minutes > 0 || hours > 0 || days > 0) timeString += `${minutes}분 `;
                    timeString += `${seconds}초 남음`;
                    
                    el.textContent = timeString.trim();
                });
            }, 1000);
        };
        
        // 6. Firestore 리스너 시작
        const startHomeworkListener = () => {
            const homeworksRef = collection(db, `artifacts/${appId}/users/${userId}/homeworks`);
            const q = query(homeworksRef); // Firestore 쿼리 (클라이언트에서 정렬하므로 orderBy는 제거)

            // 실시간 데이터 변경 감지
            onSnapshot(q, (snapshot) => {
                homeworksData = [];
                snapshot.forEach(doc => {
                    // 데이터는 중요도와 마감 기한이 포함됨
                    const data = doc.data();
                    homeworksData.push({
                        id: doc.id,
                        name: data.name,
                        deadline: data.deadline, // Firestore Timestamp 객체
                        importance: data.importance,
                        createdAt: data.createdAt
                    });
                });
                loadingStatus.textContent = '✅ 로드 완료';
                renderHomeworks(); // 데이터가 변경될 때마다 렌더링 및 클라이언트 정렬
                startCountdown(); // 카운트다운 재시작
            }, (error) => {
                console.error("Firestore 데이터 로딩 오류:", error);
                loadingStatus.textContent = '❌ 데이터 로드 오류';
            });
        };

        // 7. 숙제 추가 핸들러
        addHomeworkBtn.addEventListener('click', async () => {
            const name = homeworkNameInput.value.trim();
            const deadline = deadlineDateTimeInput.value;
            const importance = parseInt(importanceInput.value);

            formMessage.classList.add('hidden'); // 이전 메시지 숨김

            if (!name || !deadline || isNaN(importance)) {
                // ✅ 필수 입력 누락 시 명확한 시각적 피드백 제공
                formMessage.textContent = "❌ 숙제 이름, 마감 기한(날짜+시간), 중요도를 모두 입력했는지 확인해 주세요.";
                formMessage.classList.remove('hidden');
                console.error("필수 입력 필드를 모두 채워주세요.");
                return;
            }

            try {
                addHomeworkBtn.disabled = true;
                addHomeworkBtn.textContent = '추가 중...';

                const homeworksRef = collection(db, `artifacts/${appId}/users/${userId}/homeworks`);
                
                // Firestore에 데이터 추가
                await addDoc(homeworksRef, {
                    name: name,
                    // ISO 날짜 문자열을 Date 객체로 변환하여 Firestore Timestamp로 저장
                    deadline: new Date(deadline), 
                    importance: importance,
                    createdAt: serverTimestamp()
                });

                // 입력 필드 초기화
                homeworkNameInput.value = '';
                deadlineDateTimeInput.value = '';
                importanceInput.value = '3';
                
                // ✅ 성공 메시지 표시
                formMessage.textContent = "✅ 숙제가 성공적으로 추가되었습니다!";
                formMessage.classList.remove('hidden');
                setTimeout(() => formMessage.classList.add('hidden'), 3000); // 3초 후 숨김

            } catch (error) {
                console.error("숙제 추가 오류:", error);
                formMessage.textContent = `❌ 숙제 추가 중 오류 발생: ${error.message}`;
                formMessage.classList.remove('hidden');
            } finally {
                addHomeworkBtn.disabled = false;
                addHomeworkBtn.textContent = '숙제 추가';
            }
        });

        // 8. 숙제 삭제 핸들러 (이벤트 위임 사용)
        homeworksList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.getAttribute('data-id');
                if (!docId) return;

                // UX를 위해 버튼 비활성화
                e.target.disabled = true;
                e.target.textContent = '...';

                try {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/homeworks`, docId);
                    // ✅ 실제 Firestore 문서 삭제로 변경 (deleteDoc 사용)
                    await deleteDoc(docRef);
                    
                    // 삭제가 성공하면 onSnapshot 리스너가 목록을 자동으로 업데이트합니다.
                } catch (error) {
                    console.error("숙제 삭제 오류:", error);
                    e.target.disabled = false;
                    e.target.textContent = '삭제';
                }
            }
        });

        // 앱 시작
        initFirebase();

    </script>
</body>
</html>
